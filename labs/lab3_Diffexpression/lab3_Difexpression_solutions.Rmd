---
title: "lab3: Differetial Gene Expression Analysis"
author: "Your name or nickname"
date: "2025-07-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
# Load necessary libraries for differential expression analysis
library(tximport)     # tximport() imports and summarizes transcript-level abundance estimates from salmon
library(tidyverse)    # Collection of packages for data manipulation and visualization
library(DESeq2)       # DESeq2() performs differential expression analysis for RNA-seq count data
library(AnnotationDbi) # mapIds() provides gene annotation mapping functions
library(org.Hs.eg.db) # Human genome annotation database for gene symbol/name mapping
```

## Load Gene Level Quantification and Design File from Previous Lab

```{r}
txi <- readRDS("../lab2_Load_Data_and_EDA/txi_EMT_data.rds")
design_file <- readRDS("../lab2_Load_Data_and_EDA/design_table.rds")
```

```{r}
# Construct DESeqDataSet from the txi object and sample information

ddsTxi <- DESeqDataSetFromTximport(txi,
                                   colData = design_file,
                                   design = ~ Condition) 

ddsTxi
```
```{r}
# Display experimental conditions 
colData(ddsTxi)
```
## Set Reference Condition for Comparison

```{r}
reference <- as_tibble(colData(ddsTxi)) %>% 
  dplyr::select(Condition) %>% 
  filter(Condition == "Control") %>% 
  unique() %>% 
  unlist() %>% 
  as.character()
reference
```

```{r}
# relevel() sets Control as the reference condition
ddsTxi$Condition <- relevel(ddsTxi$Condition, ref=reference)
```

## Run Differential Expression Analysi

```{r, message = FALSE}
dds <- DESeq(ddsTxi)
```
## Filter Low Count Genes

```{r}
# counts() extracts the normalized count matrix from DESeq2 object
head(counts(dds))

# According to DESeq2 tutorial, the count of 10 is a reasonable choice. We will
# keep only counts if there are at least 10 of them in at least certain number
# of samples (which will be equal to the number of samples in the smallest 
# group / condition)

# Define smallest group size (condition with smallest number of samples)
smallestGroupSize <- 2

# rowSums() filters out genes with very low total counts across samples
# Keep genes that have at least 10 counts in at least 2 samples (smallest group 
# size) in this particular dataset

keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]
```
## Extract and Summarize Results

```{r}
# results() with alpha = 0.05 
res05 <- results(dds, alpha=0.05)
summary(res05)
```
## Visualize Results with MA Plot

```{r, fig.width=5, fig.height=5}
plotMA(res05)
```

## Create Results Directory

```{r}
# Create organized directory structure for saving analysis outputs
project_name <- "EMT"
result_folder <- paste0("results_", project_name)
if(!dir.exists(result_folder)){
  dir.create(result_folder)}
```

## Save MA Plot

```{r}
# Save MA plot
condition <- "EMT_vs_normal"
pdf(paste0(result_folder, "/", condition, "_MAplot.pdf")) 
plotMA(res05)
dev.off()
```

## Principal Component Analysis

```{r, fig.width=5, fig.height=5}
# Apply variance stabilizing transformation
vsd <- vst(dds, blind=FALSE)
colData(vsd)

# Create PCA plot
PCA_plot <- plotPCA(vsd, intgroup=c("Condition")) + 
  ggplot2::ggtitle("PCA plot") 
PCA_plot
```

## Save PCA Plot 

```{r}
# Save PCA plot for documentation
condtion <- "EMT_vs_normal"
pdf(paste0(result_folder, "/", condtion, "_PCAplot.pdf")) 
PCA_plot
dev.off()
```

## Add Gene Annotations

```{r}
# mapIds() maps Ensembl gene IDs to human-readable gene symbols

# Add Gene Symbols
res05$symbol <- mapIds(org.Hs.eg.db,
                       keys=rownames(res05),
                       column="SYMBOL",
                       keytype="ENSEMBL",
                       multiVals="first")
res05
```
```{r}
# Add Gene Names (Full Descriptions)
res05$gene_name <- mapIds(org.Hs.eg.db,
                          keys=rownames(res05),
                          column="GENENAME",
                          keytype="ENSEMBL",
                          multiVals="first")
res05
```

```{r}
# Store Ensembl IDs in a column 
res05$ENSEMBL <- rownames(res05)
```


```{r}
# Add Entrez Gene IDs (required for pathway analysis tools)
res05$ENTREZID <- mapIds(org.Hs.eg.db,
                          keys=rownames(res05),
                          column="ENTREZID",
                          keytype="ENSEMBL",
                          multiVals="first")
```

```{r}
# Display annotated results with all gene identifiers
res05
```

### Order and Export Results

```{r}
# order() sorts genes by statistical significance (lowest p-value first)
resOrdered <- res05[order(res05$padj),]
head(resOrdered, 20)
```

```{r}
# as.data.frame() converts DESeq2 results to standard data frame for export
resOrderedDF <- as.data.frame(resOrdered)

# Save results as tsv file
write_tsv(resOrderedDF, 
          file = paste0(result_folder, "/", 
                        condtion, 
                        "_all_genes_results.tsv"))

# subset() extracts significantly upregulated genes (padj < 0.05 & log2FC > 0)
upreg_and_signif <- subset(
  resOrderedDF,padj < 0.05 & log2FoldChange > 0) %>% 
  arrange(desc(log2FoldChange))

# Preview table 
head(upreg_and_signif)

# Save results as tsv file
write_tsv(upreg_and_signif, 
          file = paste0(result_folder, "/", 
                        condtion, 
                        "_upreg_genes_results.tsv"))

# subset() extracts significantly downregulated genes (padj < 0.05 & log2FC < 0)
downreg_and_signif <- subset(
  resOrderedDF,padj < 0.05 & log2FoldChange < 0) %>% 
  arrange(log2FoldChange)

# Preview table 
head(downreg_and_signif)

# Save results as tsv file
write_tsv(downreg_and_signif, file = paste0(result_folder, "/", condtion, "_downreg_genes_results.tsv"))
```

```{r}
# write a comment
sessionInfo() 
```

